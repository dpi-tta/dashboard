<%= render "cohorts/tabs" %>

<div class="row mb-3">
  <div class="col-lg-12 mb-3">
    <div class="d-flex align-items-center">
      <h1 class="me-auto"><%= @cohort.name %></h1>
      <%= link_to "Back to cohorts", cohorts_path, class: "btn btn-outline-secondary me-2" %>
      <% if policy(@cohort).edit? %>
        <%= link_to "Edit this cohort", edit_cohort_path(@cohort), class: "btn btn-outline-secondary me-2" %>
      <% end %>

      <% if policy(@cohort).destroy? %>
        <%= link_to "Delete this cohort", @cohort, data: { "turbo-method": :delete, "turbo-confirm": "Are you sure? This is NOT reversible" }, class: "btn btn-outline-secondary" %>
      <% end %>
    </div>
    <div class="d-flex">
      <%= @cohort.started_on.strftime("%B %Y") %>
    </div>
  </div>
</div>

<% if policy(@cohort).canvas_highest_position_submission_count? %>
  <div class="row mb-3">
    <div class="col-lg-12">
      <div class="card">
        <div class="card-header">
          <h2 class="h6 mb-0">Canvas: Highest Position Submission Count</h2>
        </div>
        <div class="card-body">
          <% canvas_count_data = @cohort.canvas_assignments.group_by_highest_position_submission_count.map { |canvas_assignment| [canvas_assignment.name, canvas_assignment.student_count] } %>
          <%= column_chart canvas_count_data %>
        </div>
      </div>
    </div>
  </div>
<% end %>

<% if policy(@cohort).canvas_point_total_most_recent? %>
  <div class="row mb-3">
    <div class="col-lg-12">
      <div class="card">
        <div class="card-header">
          <h2 class="h6 mb-0">Canvas: Total Points (most recent snapshot)</h2>
        </div>
        <div class="card-body">
          <%# TODO: refactor to scope? %>
          <%= column_chart  @cohort
                            .enrollments
                            .joins(:user, canvas_submissions: { canvas_gradebook_snapshot: :user })
                            .where('canvas_gradebook_snapshots.created_at = (SELECT MAX(created_at) FROM canvas_gradebook_snapshots)')
                            .group('users.id', 'users.first_name', 'users.last_name')
                            .order('SUM(canvas_submissions.points) DESC')
                            .pluck('users.first_name', 'users.last_name', 'SUM(canvas_submissions.points)')
                            .map { |first_name, last_name, point_total| ["#{first_name} #{last_name}", point_total] }
          %>
        </div>
      </div>
    </div>
  </div>
<% end %>

<% if policy(@cohort).canvas_cumulative_points? %>
  <div class="row mb-3">
    <div class="col-lg-12">
      <div class="card">
        <div class="card-header">
          <h2 class="h6 mb-0">Canvas: Total Points (cumulative)</h2>
        </div>
        <div class="card-body">
          <%# TODO: refactor to scope? %>
          <%= column_chart  @cohort
                            .enrollments
                            .joins(:user, :canvas_submissions)
                            .group('enrollments.id', 'users.first_name', 'users.last_name')
                            .order('SUM(canvas_submissions.points) DESC')
                            .pluck('users.first_name', 'users.last_name', 'SUM(canvas_submissions.points)')
                            .map { |first_name, last_name, point_total| ["#{first_name} #{last_name}", point_total]}
          %>
        </div>
      </div>
    </div>
  </div>
<% end %>

<% if policy(@cohort).piazza_post_views? %>
  <div class="row mb-3">
    <div class="col-lg-12">
      <div class="card">
        <div class="card-header">
          <h2 class="h6 mb-0">Piazza: Post Views</h2>
        </div>

        <div class="card-body">
          <%
            post_views_data = @cohort.enrollments.student.map do |enrollment|
              {
                name: enrollment.user.to_s,
                data: @cohort.piazza_activity_reports.map { |report| [report.activity_until, report.piazza_activity_breakdowns.find_by(enrollment:)&.post_views] }
              }
            end
          %>
          
          <%= line_chart(post_views_data, curve: false) %>
        </div>
      </div>
    </div>
  </div>
<% end %>
<% if policy(@cohort).piazza_posts? %>
  <div class="row mb-3">
    <div class="col-lg-12">
      <div class="card">
        <div class="card-header">
          <h2 class="h6 mb-0">Piazza: Posts</h2>
        </div>

        <div class="card-body">
          <%
            posts_data = @cohort.enrollments.student.map do |enrollment|
              {
                name: enrollment.user.to_s,
                data: @cohort.piazza_activity_reports.map { |report| [report.activity_until, report.piazza_activity_breakdowns.find_by(enrollment: enrollment)&.posts] }
              }
            end
          %>
          
          <%= line_chart(posts_data, curve: false) %>
        </div>
      </div>
    </div>
  </div>
<% end %>
