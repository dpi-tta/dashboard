<%= render "cohorts/tabs" %>
<div class="row mb-3">
  <div class="col-lg-12 mb-3">
    <div class="d-flex justify-content-between">
      <%= render @canvas_gradebook_snapshot %>
      <div>
        <button type="button" class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#feedbackReportModal">
          <i class="fa-solid fa-chart-line me-2"></i>Generate & Send Feedback Reports
        </button>
        <%= link_to cohort_canvas_gradebook_snapshot_url(@canvas_gradebook_snapshot.cohort, @canvas_gradebook_snapshot, format: :csv), class: "btn btn-outline-primary me-2" do %>
          <i class="fa-solid fa-file-csv"></i>
        <% end %>
        <% if policy(@canvas_gradebook_snapshot).destroy? %>
          <%= link_to cohort_canvas_gradebook_snapshot_url(@canvas_gradebook_snapshot.cohort, @canvas_gradebook_snapshot), data: { "turbo-method": :delete, "turbo-confirm": "Are you sure? This is NOT reversible" }, class: "btn btn-outline-danger" do %>
            <i class="fa-solid fa-trash"></i>
          <% end %>
        <% end %>
      </div>
    </div>
  </div>
</div>
<%= render "table", canvas_gradebook_snapshot: @canvas_gradebook_snapshot %>

<!-- Feedback Report Modal -->
<div class="modal fade" id="feedbackReportModal" tabindex="-1" aria-labelledby="feedbackReportModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="feedbackReportModalLabel">Generate & Send Feedback Reports</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <%= form_tag cohort_feedback_reports_batch_path(@cohort), method: :post, id: "feedback-report-form" do %>
        <div class="modal-body">
          <%= hidden_field_tag :canvas_gradebook_snapshot_id, @canvas_gradebook_snapshot.id %>
          <%= hidden_field_tag :cohort_id, @cohort.id %>
          
          <div class="alert alert-info">
            <i class="fa-solid fa-info-circle me-2"></i> This will generate feedback reports for all students in the cohort and send them via Discord. Only students with a Discord ID will receive reports.
          </div>
          
          <div class="row mb-3">
            <div class="col-md-6">
              <label for="start_date" class="form-label">Start Date</label>
              <%= date_field_tag :start_date, 2.weeks.ago.to_date, class: "form-control", required: true %>
            </div>
            <div class="col-md-6">
              <label for="end_date" class="form-label">End Date</label>
              <%= date_field_tag :end_date, Date.today, class: "form-control", required: true %>
            </div>
          </div>
          
          <div class="mb-3">
            <label class="form-label">Select Assignments</label>
            <div class="d-flex mb-2">
              <button type="button" id="select-all-btn" class="btn btn-sm btn-outline-primary me-2">Select All</button>
              <button type="button" id="clear-all-btn" class="btn btn-sm btn-outline-secondary">Clear All</button>
            </div>
            <div class="assignment-list">
              <% @canvas_gradebook_snapshot.canvas_assignments.each do |assignment| %>
                <div class="form-check">
                  <%= check_box_tag "assignments[]", assignment.id, true, class: "form-check-input assignment-checkbox", id: "assignment-#{assignment.id}" %>
                  <label for="assignment-<%= assignment.id %>" class="form-check-label"><%= assignment.name %></label>
                </div>
              <% end %>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary" id="generate-btn">Generate & Send Reports</button>
        </div>
      <% end %>
    </div>
  </div>
</div>

<% content_for :javascript do %>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const selectAllBtn = document.getElementById('select-all-btn');
      const clearAllBtn = document.getElementById('clear-all-btn');
      const generateBtn = document.getElementById('generate-btn');
      const assignmentCheckboxes = document.querySelectorAll('.assignment-checkbox');
      const form = document.getElementById('feedback-report-form');
      
      // Select/Clear all buttons
      selectAllBtn.addEventListener('click', function(e) {
        e.preventDefault();
        assignmentCheckboxes.forEach(cb => cb.checked = true);
      });
      
      clearAllBtn.addEventListener('click', function(e) {
        e.preventDefault();
        assignmentCheckboxes.forEach(cb => cb.checked = false);
      });
      
      // Form submission
      form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Validate form
        const startDate = document.getElementById('start_date').value;
        const endDate = document.getElementById('end_date').value;
        const selectedAssignments = Array.from(assignmentCheckboxes).filter(cb => cb.checked);
        
        if (!startDate || !endDate) {
          alert('Please select start and end dates.');
          return;
        }
        
        if (selectedAssignments.length === 0) {
          alert('Please select at least one assignment.');
          return;
        }
        
        // Show loading state
        generateBtn.disabled = true;
        generateBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Generating & Sending...';
        
        // Submit form
        this.submit();
      });
    });
  </script>
<% end %>
