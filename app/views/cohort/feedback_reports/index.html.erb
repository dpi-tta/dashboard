<%= render "cohorts/tabs" %>

<div class="card mb-4">
  <div class="card-header d-flex justify-content-between align-items-center">
    <h1 class="h5 mb-0">Feedback Reports</h1>
    <div>
      <div class="d-flex flex-row gap-2 align-items-center">
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#feedbackReportModal">
          <i class="fa-solid fa-chart-line me-2"></i>Generate Feedback Reports
        </button>
      </div>
    </div>
  </div>
  <div class="card-body">
    <% if @cohort.canvas_gradebook_snapshots.any? %>
      <% if @feedback_reports.any? %>
        <div class="table-responsive">
          <table class="table">
            <thead>
              <tr>
                <th>Student</th>
                <th>Period</th>
                <th>Created</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <% @feedback_reports.each do |report| %>
                <tr>
                  <td><%= report.enrollment.user.name %></td>
                  <td>
                    <%= report.start_date.strftime("%B %d, %Y") %> - 
                    <%= report.end_date.strftime("%B %d, %Y") %>
                  </td>
                  <td><%= report.created_at.strftime("%B %d, %Y at %I:%M %p") %></td>
                  <td>
                    <% if report.sent? %>
                      <span class="badge bg-success">
                        <i class="fa-solid fa-check-circle me-1"></i> Sent
                      </span>
                    <% elsif report.error_message.present? %>
                      <span class="badge bg-danger">
                        <i class="fa-solid fa-exclamation-circle me-1"></i> Failed
                      </span>
                    <% else %>
                      <span class="badge bg-info">
                        <i class="fa-solid fa-clock me-1"></i> Pending
                      </span>
                    <% end %>
                  </td>
                  <td>
                    <div class="btn-group">
                      <%= link_to "View", cohort_feedback_report_path(@cohort, report), 
                          class: "btn btn-sm btn-outline-primary" %>
                      <% unless report.sent? %>
                        <%= button_to "Send", send_report_cohort_feedback_report_path(@cohort, report),
                            method: :post,
                            class: "btn btn-sm btn-outline-success",
                            form: { data: { turbo_confirm: "Are you sure you want to send this feedback report?" } } %>
                      <% end %>
                    </div>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      <% else %>
        <div class="alert alert-info">
          <i class="fa-solid fa-info-circle me-2"></i> No feedback reports have been created yet.
        </div>
      <% end %>
    <% else %>
      <div class="alert alert-warning">
        <i class="fa-solid fa-exclamation-triangle me-2"></i> Please upload a Canvas gradebook snapshot before attempting to use this tool.
      </div>
    <% end %>
  </div>
</div>

<!-- Feedback Report Modal -->
<div class="modal fade" id="feedbackReportModal" tabindex="-1" aria-labelledby="feedbackReportModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="feedbackReportModalLabel">Generate Feedback Reports</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <% if @cohort.canvas_gradebook_snapshots.any? %>
        <%= form_tag cohort_feedback_reports_batch_path(@cohort), method: :post, id: "feedback-report-form" do %>
          <div class="modal-body">
            <div class="alert alert-info">
              <i class="fa-solid fa-info-circle me-2"></i> This will generate feedback reports for all students in the cohort. You can review and send them later.
            </div>
            
            <div class="mb-3">
              <label for="canvas_gradebook_snapshot_id" class="form-label">Canvas Gradebook Snapshot</label>
              <%= select_tag :canvas_gradebook_snapshot_id, 
                  options_from_collection_for_select(@cohort.canvas_gradebook_snapshots.default_order, :id, :to_s),
                  class: "form-select",
                  required: true %>
            </div>
            
            <div class="row mb-3">
              <div class="col-md-6">
                <label for="start_date" class="form-label">Start Date</label>
                <%= date_field_tag :start_date, 2.weeks.ago.to_date, class: "form-control", required: true %>
              </div>
              <div class="col-md-6">
                <label for="end_date" class="form-label">End Date</label>
                <%= date_field_tag :end_date, Date.today, class: "form-control", required: true %>
              </div>
            </div>
            
            <div class="mb-3">
              <label class="form-label">Select Assignments</label>
              <div class="d-flex mb-2">
                <button type="button" id="select-all-btn" class="btn btn-sm btn-outline-primary me-2">Select All</button>
                <button type="button" id="clear-all-btn" class="btn btn-sm btn-outline-secondary">Clear All</button>
              </div>
              <div class="assignment-list">
                <% if @cohort.canvas_gradebook_snapshots.default_order.first&.canvas_assignments&.any? %>
                  <% @cohort.canvas_gradebook_snapshots.default_order.first.canvas_assignments.each do |assignment| %>
                    <div class="form-check">
                      <%= check_box_tag "assignments[]", assignment.id, true, class: "form-check-input assignment-checkbox", id: "assignment-#{assignment.id}" %>
                      <label for="assignment-<%= assignment.id %>" class="form-check-label"><%= assignment.name %></label>
                    </div>
                  <% end %>
                <% else %>
                  <div class="alert alert-warning">
                    <i class="fa-solid fa-exclamation-triangle me-2"></i> No assignments found in the selected snapshot.
                  </div>
                <% end %>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary" id="generate-btn">Generate Reports</button>
          </div>
        <% end %>
      <% else %>
        <div class="modal-body">
          <div class="alert alert-warning">
            <i class="fa-solid fa-exclamation-triangle me-2"></i> Please upload a Canvas gradebook snapshot before attempting to use this tool.
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      <% end %>
    </div>
  </div>
</div>

<% content_for :javascript do %>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const selectAllBtn = document.getElementById('select-all-btn');
      const clearAllBtn = document.getElementById('clear-all-btn');
      const generateBtn = document.getElementById('generate-btn');
      const assignmentCheckboxes = document.querySelectorAll('.assignment-checkbox');
      const form = document.getElementById('feedback-report-form');
      const snapshotSelect = document.getElementById('canvas_gradebook_snapshot_id');
      
      // Update assignments when snapshot changes
      snapshotSelect.addEventListener('change', function() {
        const snapshotId = this.value;
        if (snapshotId) {
          fetch(`/cohorts/<%= @cohort.id %>/canvas_gradebook_snapshots/${snapshotId}/assignments`)
            .then(response => response.json())
            .then(assignments => {
              const assignmentList = document.querySelector('.assignment-list');
              assignmentList.innerHTML = assignments.map(assignment => `
                <div class="form-check">
                  <input type="checkbox" name="assignments[]" value="${assignment.id}" class="form-check-input assignment-checkbox" id="assignment-${assignment.id}" checked>
                  <label for="assignment-${assignment.id}" class="form-check-label">${assignment.name}</label>
                </div>
              `).join('');
            });
        }
      });
      
      // Select/Clear all buttons
      selectAllBtn.addEventListener('click', function(e) {
        e.preventDefault();
        assignmentCheckboxes.forEach(cb => cb.checked = true);
      });
      
      clearAllBtn.addEventListener('click', function(e) {
        e.preventDefault();
        assignmentCheckboxes.forEach(cb => cb.checked = false);
      });
      
      // Form submission
      form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Validate form
        const snapshotId = document.getElementById('canvas_gradebook_snapshot_id').value;
        const startDate = document.getElementById('start_date').value;
        const endDate = document.getElementById('end_date').value;
        const selectedAssignments = Array.from(assignmentCheckboxes).filter(cb => cb.checked);
        
        if (!snapshotId) {
          alert('Please select a Canvas Gradebook Snapshot.');
          return;
        }
        
        if (!startDate || !endDate) {
          alert('Please select start and end dates.');
          return;
        }
        
        if (selectedAssignments.length === 0) {
          alert('Please select at least one assignment.');
          return;
        }
        
        // Show loading state
        generateBtn.disabled = true;
        generateBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Generating...';
        
        // Submit form
        this.submit();
      });
    });
  </script>
<% end %>
